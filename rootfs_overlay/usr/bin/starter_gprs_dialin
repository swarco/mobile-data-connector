#!/bin/sh
#*****************************************************************************
#* 
#*  @file          starter_gprs_dialin
#*
#*  GPRS pppd periodic starter script
#*
#*  @version       1.0 (\$Revision$)
#*  @author        Guido Classen <br>
#*                 Weiss-Electronic GmbH
#* 
#*  $LastChangedBy$  
#*  $Date$
#*  $URL$
#*
#*  @par Modification History:
#*    2007-12-04 gc: initial version
#*
#*  
#*****************************************************************************

while true
do

    if ! [ -f /etc/default/gprs ]
    then
        echo "Config file /etc/default/gprs not found, nothing to do!"
        exit 1
    fi

    GPRS_PPP_OPTIONS=""
    . /etc/default/gprs

    if [ -z "$GPRS_DEVICE" -o \
        -z "$GPRS_APN" ]
    then
        echo "Necessary settings missing in /etc/default/gprs"
        exit 1
    fi

    if [ -f /tmp/gprs_disable ]
    then
        echo "GPRS dialin disabled"
        exit 1
    fi

    if ! [ -z "$GPRS_DNS2" -a \
           -z "$GPRS_DNS2" ]
    then
        #truncate file without removing it (in case of symbolic link)
        echo "#resolv.conf file automatically created by $0" >/etc/resolv.conf

        if ! [ -z "$GPRS_DNS1" ]
        then
            echo >>/etc/resolv.conf "nameserver $GPRS_DNS1"
        fi
        if ! [ -z "$GPRS_DNS2" ]
        then
            echo >>/etc/resolv.conf "nameserver $GPRS_DNS2"
        fi
    else
        GPRS_PPP_OPTIONS="$GPRS_PPP_OPTIONS usepeerdns"
    fi

    export GPRS_DEVICE
    export GPRS_BAUDRATE
    export GPRS_PIN
    export GPRS_APN
    export GPRS_DIAL
    export GPRS_OPERATOR
    export GPRS_USER
    export GPRS_PPP_OPTIONS

    comgt /etc/ppp/comgt_gprs.scr -s | logger -p daemon.notice -t GPRS

    sleep 30
done
